name: Publish XAT

on:
  workflow_dispatch:

jobs:

  build:
    runs-on: windows-latest

    steps:
    - name: Generate version
      uses: josStorer/get-current-time@v2
      id: version-date
      with:
        format: YYYY.MM.DD.HHmm

    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        
    - name: Install .NET
      uses: actions/setup-dotnet@v1.8.2
      with:
        dotnet-version: 6.0.x
   
    - name: Deploy XAT
      run: dotnet publish XAT/XAT.sln /p:DebugType=None /p:DebugSymbols=false /p:PublishProfile=FinalPublish /p:Version=${{ steps.version-date.outputs.formattedTime }}

    - name: Download Dalamud
      run: |
        Invoke-WebRequest -Uri https://goatcorp.github.io/dalamud-distrib/stg/latest.zip -OutFile latest.zip
        Expand-Archive -Force latest.zip "$env:AppData\XIVLauncher\addon\Hooks\dev"

    - name: Deploy XAT Dalamud
      run: dotnet publish Dalamud/XAT.Plugin.sln /p:DebugType=None /p:DebugSymbols=false /p:PublishProfile=FinalPublish /p:Version=${{ steps.version-date.outputs.formattedTime }}
      
    - name: Zip Standalone Release
      uses: TheDoctor0/zip-release@0.6.0
      with:
        filename: '../XAT-Standalone.zip'
        directory: './publish-standalone/'
        exclusions: '*.pdb* *.xml*'

    - name: Zip Dalamud Release
      uses: TheDoctor0/zip-release@0.6.0
      with:
        filename: '../XAT-Dalamud-Plugin.zip'
        directory: './publish-dalamud/'
        exclusions: '*.pdb* *.xml*'

    - name: Zip Blender Release
      uses: TheDoctor0/zip-release@0.6.0
      with:
        filename: '../XAT-Blender-Addon.zip'
        directory: './Blender/'
        
    - name: Upload Release
      uses: ncipollo/release-action@v1
      with:
        allowUpdates: true
        artifacts: "XAT-Standalone.zip,XAT-Blender-Addon.zip,XAT-Dalamud-Plugin.zip"
        name: ${{ steps.version-date.outputs.formattedTime }}
        tag: v${{ steps.version-date.outputs.formattedTime }}
        draft: true
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Write out repo.json
      run: |
        $ver = '${{ steps.version-date.outputs.formattedTime }}'
        $path = './base_repo.json'
        $new_path = './repo.json'
        $content = get-content -path $path
        $content = $content -replace '1.0.0.0',$ver
        set-content -Path $new_path -Value $content

    - name: Commit repo.json
      run: |
        git config --global user.name "Actions User"
        git config --global user.email "actions@github.com"
        git fetch origin master && git fetch origin test && git checkout master
        git add repo.json
        git commit -m "[CI] Updating repo.json for ${{ github.ref }}" || true
        git push origin master || true
        git branch -f test origin/master && git checkout test
        git push origin test -f || true